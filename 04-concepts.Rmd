# Some important concepts and pitfalls

## Scale

All maps have a scale. Scale is the ratio between the size of the representation of an object and its size in reality. E.g. objects on a 1:50,000 scale map are drawn at 1/50,000 their size, so 1cm on the map represents a distance of 500m in reality (i.e. $1*50,000 = 50,000cm = 500m$).

```{r onein50, echo=FALSE, warning=F, message=F}
# library(raster)
# 
# one50 <- raster("/home/jasper/GIT/spatial-r/data/cape_peninsula/1in50topo/3418AB_AD_2000_ED7_GEO.TIF")
# 
# plot(one50)
```


GIS is usually scaleless (or at least flexible in scale); we can "zoom in" as much as we want to, and perform operations at just about any scale we want to, but should we? There are lots of issues we need to consider!

* **Representation...** There are 2 issues here:
  - Firstly, a 1mm thick line on a 1:50,000 scale map would be 50m wide in reality. A 5m wide road would be 1/10mm on the map. Would the map be readable? Sometimes we break the rules of scale to make maps readable. Bear this in mind!
  - Secondly, representation also becomes an issue of how to capture data. For example, a road is typically best represented as a line at 1:5,000 scale or smaller, but at 1:1,000 scale a 5m wide road would be 5mm across on the map, so one might capture it as a polygon to represent its area.
* **Accuracy** of location versus scale of data capture. We should always check the scale at which the data were captured to make sure it is accurate enough for the scale of the analysis we are doing. For example, the various vegetation units in the National Vegetation Map of South Africa were mapped at a range of scales, some as small as 1:250,000 (note that small scale = large extent or area!). At this scale 1mm = 250m, so a minor digitization error is a huge difference on the ground! If you need your analysis to be accurate to <10m then you'd probably need data mapped at a scale larger than 1:10,000.
* **Precision** - Can mean two things:
  - The unit or number of decimal places to which the attribute has been measured (and can be stored)
  - The spread of repeat measurements (typically in field data collection). A big spread means the measurements weren't very precise...

<br>

### A quick aside on the difference between accuracy and precision! {.unlisted .unnumbered}

```{r accuracyprecision, fig.cap='The difference between accuracy and precision.', fig.asp=1, fig.align='center', echo=FALSE, warning=F, message=F}
library(tidyverse)
library(hrbrthemes)

data <- data.frame(set = factor(x = c(rep("precise and accurate", 50), rep("precise, but inaccurate",50), rep("imprecise, but accurate", 50), rep("imprecise and inaccurate", 50)), levels = c("precise and accurate", "precise, but inaccurate", "imprecise, but accurate", "imprecise and inaccurate")), x = c(rnorm(50, mean = 0, sd = 1), rnorm(50, mean = 1.5, sd = 1), rnorm(50, mean = 0, sd = 1.5), rnorm(50, mean = 1.5, sd = 1.5)), y = c(rnorm(50, mean = 0, sd = 1), rnorm(50, mean = 1.5, sd = 1), rnorm(50, mean = 0, sd = 1.5), rnorm(50, mean = 1.5, sd = 1.5)))

data %>%
 # tail(10) %>%
  ggplot(aes(x=x, y=y)) +
    #geom_polygon(fill = "grey") +
    #geom_path(color="black") +
    geom_hline(yintercept = 0) + geom_vline(xintercept = 0) +
    geom_point(shape=21, color="black", fill="#69b3a2", size=3) +
    theme_ipsum() + ylim(-5,5) + xlim(-5,5) +
    facet_wrap(.~set)

```
 
<br>

**A last word on Scale...**
 
For vector data, we typically refer to scale when describing a data set.

For raster data, we typically refer to pixel resolution (or sample interval). For example, a 30m digital elevation model is made up of pixels 30m across. For remotely sensed imagery (i.e. from drone, plane or satellite), one often uses the term "ground sample distance".

<br>

## Coordinate Reference Systems (CRS)

Coordinate Reference Systems (CRS) provide a framework for defining real-world locations. There are many different CRSs, with different properties. They can be a minefield, and I don't have the time to cover them in any detail here. I provide some of the basics below, but for me the two golden rules are:

1. You need to **_know what CRS your dataset is in_**. This is essential for as it allows it to be reprojected to align with other datasets you are working with. If your datasets are not in the same CRS, most GIS software will give you warning or error messages, but not always! Note that not all file formats store the CRS "metadata", so check and store it yourself if needed! 
2. You need to make sure you **_use a CRS that is appropriate for the analysis_** or representation you are planning. More on this below in section \@ref(projections)

### Geographic (or "unprojected") Coordinate Systems

The most common coordinate system is latitude/longitude, also known as _geographic_, lat/long or sometimes _WGS84_. There are many ways to record geographic coordinates:

* Degrees, Minutes & Seconds: S33°26’46”,E18°10’23’’
* Decimal Degrees: -33.4461111,18.17305556
* Most GIS prefer decimal degrees...

The problem with doing analyses using geographic CRS is that lat/long coordinates are actually angular measurements on a 3D sphere (Geodesic) and degrees differ in their actual ground distance depending on where you are on the planet. They also differ in the N-S vs W-E plane!

<br>

```{r geocoords, echo=FALSE, fig.cap = 'Map highlighting that a degree is larger at the equator than at the poles. Image source: https://annakrystalli.me/intro-r-gis/gis.html', fig.width=4, fig.align = 'center'}
knitr::include_graphics("img/geographiccoords.gif")
```

<br>

This means that Euclidean measurement calculations are not appropriate for calculating areas and distances.

<br>

### Projected Coordinate Systems {#projections}

To perform linear measurements from a 3D shape using Euclidean methods, you need to squash that shape into a 2D plane. This _squashing_ is called a _projection_...

<br>

```{r naartjie, echo=FALSE, fig.cap = 'How many different ways could you flatten a naartjie peel?', fig.width=4, fig.align = 'center'}
knitr::include_graphics("img/projectednaartjie.jpg")
```

<br>

There are 4 properties that get distorted, you can pick which one gets preserved the best by a projection type:

* Shape - you want a _Conformal_ projection 
* Area - _Equal-Area_
* Distance - _Equidistant_
* Direction - _Azimuthal_

Projections get tuned to best fit an area through the use of projection parameters. An example is the Transverse Mercator system used by the 1:50,000 map series and by Municipalities like Cape Town. This is a general-purpose map, so in order to keep all distortions to a minimum, the projection window is kept to narrow 2 degree-wide bands. As a result, our map series projection parameters are set by moving the central meridian (or tangent) line of longitude every odd degree across the country. Cape Town is close to 19°E, so our version is colloquially called 'Lo-19'.

<br>

### Projection codes

The type of CRS is usually (but not always) stored in the metadata of your file (or dataset, if it is comprised of many files like an ESRI shapefile). There are various formats for this, such as EPSG, PROJ4 or WKT (be warned, there are many more...). In R, to apply a CRS or reproject your data you typically need to know the EPSG or PROJ4 code. Fortunately, there is a huge online library of these at [https://spatialreference.org/](https://spatialreference.org/). I also provide **some suggested projections**, based on the properties you'd like to preserve, and their codes below:

For South Africa

* Shape - you want a _Conformal_ projection 
* Area - _Equal-Area_ - Albers Equal Area etc?
* Distance - _Equidistant_
* Direction - _Azimuthal_

For the Cape Town area (with some guidance on how to alter it for different regions within SA)

* Shape - TM ("+proj=tmerc +lat_0=0 +lon_0=19 +k=1 +x_0=0 +y_0=0 +ellps=WGS84 +units=m +no_defs")? UTM34S? 
* Area - _Equal-Area_ - Albers Equal Area etc?
* Distance - _Equidistant_
* Direction - _Azimuthal_

Perhaps add a figure of SA or CoCT in different projections...

<br>

### "On the fly" vs manual projection

Note that some GIS tools can perform "on the fly" (re)projection of data. For example, by default ArcGIS sets the CRS for a project from the first dataset imported. When you want to visualize the data, it will reproject all other datasets to the set CRS so that it can visualize it properly. Similarly, ArcGIS and other software can project data in a geographic CRS to a projected CRS on the fly when asked to perform Euclidean measurement calculations.

On the fly projection can clearly be very useful, but it can also be misleading if you don't know what its doing. My take is that you should always check the default settings for the software you're using, and check the set CRS(s) and individual dataset CRS(s) to make sure you are working in a suitable CRS for the operations you want to perform...

